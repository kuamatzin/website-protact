<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Panel de Cliente - Protact</title>
    <meta content="Panel de inspecciones del cliente" name="description" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/favicon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Jost:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />

    <style>
      body {
        background: #f8f9fa;
      }

      .dashboard-container {
        min-height: 100vh;
        padding: 120px 0 60px;
      }

      .dashboard-header {
        background: linear-gradient(135deg, #c9232c 0%, #fb0825 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        box-shadow: 0 10px 40px rgba(201, 35, 44, 0.3);
      }

      .dashboard-header h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
      }

      .dashboard-header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .station-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .station-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
      }

      .station-card h3 {
        color: #2c2c2c;
        margin-bottom: 10px;
        font-size: 22px;
      }

      .station-address {
        color: #666;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .station-stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .stat-item i {
        font-size: 20px;
        color: #c9232c;
      }

      .stat-item span {
        font-weight: 600;
        color: #2c2c2c;
      }

      .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-in_progress {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .loading-spinner {
        text-align: center;
        padding: 60px;
      }

      .spinner-border {
        color: #c9232c;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .btn-view-inspections {
        background: linear-gradient(135deg, #c9232c 0%, #fb0825 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-top: 15px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-view-inspections:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(201, 35, 44, 0.3);
        color: white;
      }

      @media (max-width: 768px) {
        .dashboard-header h1 {
          font-size: 24px;
        }

        .station-stats {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="fixed-top">
      <div class="container d-flex align-items-center">
        <a href="/" class="logo me-auto">
          <img src="assets/img/white_logo.png" alt="" class="img-fluid" />
        </a>
      </div>
    </header>
    <!-- End Header -->

    <main class="dashboard-container">
      <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-spinner">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-3">Cargando información...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none">
          <div class="error-message">
            <h4><i class="bi bi-exclamation-triangle"></i> Error</h4>
            <p id="errorMessage"></p>
            <button class="btn btn-danger mt-2" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise"></i> Reintentar
            </button>
          </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none">
          <div class="dashboard-header" data-aos="fade-down">
            <h1><i class="bi bi-building"></i> <span id="clientName"></span></h1>
            <p>Panel de inspecciones de estaciones</p>
          </div>

          <div id="stationsContainer" class="row"></div>
        </div>
      </div>
    </main>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Main JS -->
    <script src="assets/js/main.js"></script>

    <!-- API Configuration -->
    <script src="api-config.js"></script>

    <!-- Dashboard Script -->
    <script>
      // Initialize AOS
      AOS.init({
        duration: 1000,
        easing: 'ease-in-out',
        once: true,
        mirror: false,
      });

      // API Configuration - auto-detect or use environment variable
      const API_BASE_URL = window.PROTACT_API_URL || 'http://localhost:8000/api/public';

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const clientToken = urlParams.get('token');

      if (!clientToken) {
        showError('No se proporcionó un token de acceso válido.');
      } else {
        // Store token in sessionStorage for later use
        sessionStorage.setItem('clientToken', clientToken);
        loadClientData();
      }

      async function loadClientData() {
        try {
          const response = await fetch(`${API_BASE_URL}/clients/${clientToken}`);
          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error.message || 'Error al cargar los datos');
          }

          renderDashboard(data.data.client);
        } catch (error) {
          console.error('Error:', error);
          showError(error.message || 'Error al conectar con el servidor');
        }
      }

      function renderDashboard(client) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';

        // Set client name
        document.getElementById('clientName').textContent = client.name;

        // Render stations
        const stationsContainer = document.getElementById('stationsContainer');
        stationsContainer.innerHTML = '';

        if (!client.stations || client.stations.length === 0) {
          stationsContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No hay estaciones registradas.
              </div>
            </div>
          `;
          return;
        }

        client.stations.forEach((station, index) => {
          const stationCard = createStationCard(station, index);
          stationsContainer.appendChild(stationCard);
        });
      }

      function createStationCard(station, index) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        col.setAttribute('data-aos', 'fade-up');
        col.setAttribute('data-aos-delay', index * 100);

        const latestInspection = station.latest_inspection;
        const statusClass = latestInspection
          ? `status-${latestInspection.status}`
          : 'status-pending';
        const statusLabel = latestInspection
          ? latestInspection.status_label
          : 'Sin inspecciones';

        col.innerHTML = `
          <div class="station-card" onclick="viewStationInspections(${station.id})">
            <h3><i class="bi bi-geo-alt"></i> ${station.name || station.internal_name}</h3>
            <div class="station-address">
              <i class="bi bi-map"></i> ${station.address}, ${station.suburb}, ${station.city}, ${station.state}
            </div>

            ${
              latestInspection
                ? `
              <div class="mb-2">
                <strong>Última inspección:</strong>
                <span class="status-badge ${statusClass}">${statusLabel}</span>
              </div>
              <div style="font-size: 13px; color: #666;">
                ${new Date(latestInspection.inspection_start_datetime).toLocaleDateString('es-MX')}
              </div>
            `
                : '<div class="text-muted">Sin inspecciones registradas</div>'
            }

            <div class="station-stats">
              <div class="stat-item">
                <i class="bi bi-file-earmark-check"></i>
                <span>${station.inspections_count || 0} Inspecciones</span>
              </div>
            </div>

            <button class="btn-view-inspections">
              Ver Inspecciones <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        `;

        return col;
      }

      function viewStationInspections(stationId) {
        window.location.href = `station-inspections.html?token=${clientToken}&station=${stationId}`;
      }

      function showError(message) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
      }
    </script>
  </body>
</html>
